<div #tableContainer style="overflow-x: auto;">
  <table mat-table [dataSource]="tableDataSource" matSort  >
    <ng-container
      *ngFor="let column of filteredColumns; let last = last"
      [matColumnDef]="column.def"
      [sticky]="column.sticky"
      [stickyEnd]="column.stickyEnd"
    >
      <ng-container *ngIf="column.def !== 'actions'">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          [disabled]="disableSort"
          [class.mat-header-cell-checkbox]="column.type === 'checkbox'"
          [ngClass]="{'last-sticky-cell': isLastStickyColumn(column)}"
      >
        <ng-container *ngIf="column.type === 'checkbox'">
          <mat-checkbox
            [checked]="allChecked"
            [indeterminate]="someChecked()"
            (change)="setAll($event.checked)"
            (click)="$event.stopPropagation()"
          >
            {{ column.title }} 
          </mat-checkbox>
        </ng-container>
        <span *ngIf="column.type !== 'checkbox'"
        [ngClass]="{
          'align-right-title': column.def === 'a_cobrar_flete' ||
                              column.def === 'a_pagar_flete' ||
                              column.def === 'cantidad_flete' ||
                              column.def === 'credito_caja' ||
                              column.def === 'debito_caja' ||
                              column.def === 'saldo_caja' ||
                              column.def === 'credito_banco' ||
                              column.def === 'debito_banco' ||
                              column.def === 'saldo_banco',

          'align-right-cuenta':column.def === 'pendiente' ||
                                column.def === 'en_proceso' ||
                                column.def === 'confirmado' ||
                                column.def === 'cantidad_nominada' ||
                                column.def === 'cantidad_origen' ||
                                column.def === 'cantidad_destino' ||
                                column.def === 'diferencia_origen_destino' ||
                                column.def === 'condicion_propietario_tarifa' ||
                                column.def === 'propietario_flete_total' ||
                                column.def === 'propietario_flete_total_ml' ||
                                column.def === 'merma_propietario_valor' ||
                                column.def === 'merma_propietario_tolerancia' ||
                                column.def === 'merma_propietario_merma' ||
                                column.def === 'merma_propietario_valor_merma' ||
                                column.def === 'condicion_gestor_carga_tarifa' ||
                                column.def === 'gestor_carga_flete_total' ||
                                column.def === 'gestor_carga_flete_total_ml' ||
                                column.def === 'merma_gestor_carga_valor' ||
                                column.def === 'merma_gestor_carga_tolerancia' ||
                                column.def === 'merma_gestor_carga_merma' ||
                                column.def === 'merma_gestor_carga_valor_merma' ||
                                column.def === 'flete_condicion_propietario_tarifa' ||
                                column.def === 'flete_condicion_propietario_moneda_nombre' ||
                                column.def === 'flete_propietario_total' ||
                                column.def === 'flete_propietario_total_ml' ||
                                column.def === 'flete_merma_propietario_valor' ||
                                column.def === 'flete_merma_propietario_moneda_nombre' ||
                                column.def === 'flete_merma_propietario_tolerancia' ||
                                column.def === 'flete_merma_propietario_merma' ||
                                column.def === 'flete_merma_propietario_valor_merma' ||
                                column.def === 'flete_condicion_gestor_carga_tarifa' ||
                                column.def === 'flete_gestor_carga_total' ||
                                column.def === 'flete_merma_gestor_carga_valor' ||
                                column.def === 'flete_merma_gestor_carga_tolerancia' ||
                                column.def === 'flete_merma_gestor_carga_valor_merma' ||
                                column.def === 'total_complemento_a_cobrar' ||
                                column.def === 'total_descuento_a_pagar' ||
                                column.def === 'total_descuento_a_cobrar' ||
                                column.def === 'diferencia_descuento' ||
                                column.def === 'total_anticipo_retirado' ||
                                column.def === 'saldo_gestor_carga' ||
                                column.def === 'saldo_propietario', 
            'align-right-monto':column.def === 'monto' ||
                                column.def === 'monto_ml',

            'align-right-instr':column.def === 'credito_caja_instrumento' ||
                                column.def === 'debito_caja_instrumento' ||
                                column.def === 'saldo_caja' ||
                                column.def === 'credito_inst_banco' ||
                                column.def === 'debito_inst_banco'  ||
                                column.def === 'pendiente_inst_banco' ||
                                column.def === 'saldo_inst_banco',
            'align-right-liq':  column.def === 'movimientos_saldo' ||                   
                                column.def === 'instrumentos_saldo' ||
                                column.def === 'saldo_residual'
                                                                                                                
        }"
      >
          {{ column.title }}
        </span>
      </th>
      
        <td
          mat-cell
          *matCellDef="let row; let index = index"   [ngClass]="{'last-sticky-cell': isLastStickyColumn(column)}"
          [class.mat-cell-checkbox]="column.type === 'checkbox'"
          [class.row-error]="formArray.at(index)?.get(column.def)?.errors"
          [style.color]="column.def === 'estado' ? getColorForState(row[column.def]) : 'inherit'"
        >
          <ng-container
            *ngIf="
              column.value &&
              (!column.isHidden || (column.isHidden(row) && column.isHidden(row)))
            "
          >
            <ng-container [ngSwitch]="column.type">
              <ng-container *ngSwitchCase="'checkbox'">
                <mat-checkbox
                  [(ngModel)]="checkedList[index]"
                  (ngModelChange)="updateAllChecked()"
                  (change)="onCheckboxChange($event, row, index)"
                >
                  {{ column.value(row) }}
                </mat-checkbox>
              </ng-container>
              <ng-container *ngSwitchCase="'number'">
                <ng-container *ngIf="column.link">
                  <ng-container
                    *ngIf="column.link(row) as linkInfo; else withoutLink"
                  >
                    <a
                      [routerLink]="linkInfo.url"
                      [queryParams]="linkInfo.queryParams"
                    >
                      {{ column.value(row) | numberFormat }}
                    </a>
                  </ng-container>
                  <ng-template #withoutLink>
                    <span>{{ column.value(row) }}</span>
                  </ng-template>
                </ng-container>
                <ng-container *ngIf="!column.link">
                  <span>{{ column.value(row) | numberFormat }}</span>
                </ng-container>
              </ng-container>
              <ng-container *ngSwitchCase="'date'">
                <span>{{
                  column.value(row) | momentFormat: "DD-MM-YYYY HH:mm:ss"
                }}</span>
              </ng-container>
              <ng-container *ngSwitchCase="'html'">
                <div [innerHTML]="column.value(row)"></div>
              </ng-container>
              <ng-container *ngSwitchCase="'button'">
                <ng-container *ngIf="column.buttonCallback">
                  <ng-container *ngIf="column.buttonIconName; else buttonText">
                    <ng-container *ngIf="column.buttonIconName(row) as iconName">
                      <button
                        type="button"
                        mat-icon-button
                        class="row-button"
                        color="primary"
                        [matTooltip]="column.value(row)"
                        [disabled]="column.isDisable && column.isDisable(row)"
                        (click)="column.buttonCallback(row)"
                      >
                        <mat-icon>{{ iconName }}</mat-icon>
                      </button>
                    </ng-container>
                  </ng-container>
                  <ng-template #buttonText>
                    <button
                      type="button"
                      mat-raised-button
                      class="row-button"
                      color="primary"
                      [innerHTML]="column.value(row)"
                      [disabled]="column.isDisable && column.isDisable(row)"
                      (click)="column.buttonCallback(row)"
                    ></button>
                  </ng-template>
                </ng-container>
              </ng-container>
              <ng-container *ngSwitchDefault>
                <ng-container *ngIf="column.link">
                  <ng-container
                    *ngIf="column.link(row) as linkInfo; else withoutLink"
                  >
                    <a
                      [routerLink]="linkInfo.url"
                      [queryParams]="linkInfo.queryParams"
                    >
                      {{ column.value(row) }}
                    </a>
                  </ng-container>
                  <ng-template #withoutLink>
                    <span>{{ column.value(row) }}</span>
                  </ng-template>
                </ng-container>
                <ng-container *ngIf="!column.link">
                  <span>{{ column.value(row) }}</span>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
        </td>
        <ng-container *ngIf="shouldBeShowFooter">
          <td mat-footer-cell *matFooterCellDef>
            <strong [ngSwitch]="column.type">
              <ng-container *ngSwitchCase="'number'">
                {{ column.footerDef && column.footerDef() | numberFormat }}
              </ng-container>
              <ng-container *ngSwitchDefault>
                {{ column.footerDef && column.footerDef() }}
              </ng-container>
            </strong>
          </td>
        </ng-container>
      </ng-container>
      <ng-container *ngIf="column.def === 'actions'">
        <th mat-header-cell *matHeaderCellDef [hidden]="isShow && !addShowButton">
          <button
            type="button"
            mat-icon-button
            [matMenuTriggerFor]="filterColumn"
            #filterColumnTrigger
          >
            <mat-icon>list</mat-icon>
          </button>
          <mat-menu #filterColumn>
            <div mat-menu-item disableRipple>
              <app-searchable-checkbox-filter
                [value]="columnsToShowFilteredList"
                [list]="columnsToShowList"
                (valueChanges)="columnsToShowFilteredList = $event"
                (filtered)="
                  filterColumns();
                  filterColumnTrigger._elementRef.nativeElement.click()
                "
              ></app-searchable-checkbox-filter>
            </div>
          </mat-menu>
        </th>
        <td
          mat-cell
          *matCellDef="let row; let index = index" 
          [hidden]="isShow && !addShowButton"
          
        >
          <button
            type="button"
            class="row_menu"
            mat-icon-button
            matTooltip="Ver"
            (click)="showClick.emit({ row, index })"
            *ngIf="modelo | puede: a.VER"
            [hidden]="!addShowButton"
          >
            <mat-icon>visibility</mat-icon>
          </button>
          <button 
            type="button"
            class="row_menu"
            mat-icon-button
            [matMenuTriggerFor]="menu"
            [hidden]="isShow"
            *ngIf="
              ((modelo | puede: a.VER) && !hideShow) ||
              (!hideEdit &&
                (modelo
                  | puede
                    : a.EDITAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id || gestorCuentaId))) ||
              (!hideDelete &&
                (modelo
                  | puede
                    : a.ELIMINAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id || gestorCuentaId)))
            "
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button
              type="button"
              mat-menu-item
              (click)="showClick.emit({ row, index })"
              *ngIf="modelo | puede: a.VER"
              [hidden]="hideShow"
            >
              <mat-icon color="primary">visibility</mat-icon>
              <span>Ver</span>
            </button>
            <button
              type="button"
              mat-menu-item
              (click)="editClick.emit({ row, index })"
              *ngIf="
                row.estado !== e.CONCILIADO &&
                !hideEdit &&
                (modelo
                  | puede
                    : a.EDITAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">edit</mat-icon>
              <span>Editar</span>
            </button>
            <button
              type="button"
              mat-menu-item
              (click)="deleteClick.emit({ row, index })"
              *ngIf="
                !hideDelete &&
                (modelo
                  | puede
                    : a.ELIMINAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">delete</mat-icon>
              <span>Eliminar</span>
            </button>
            <button
              type="button"
              mat-menu-item
              (click)="activeClick.emit({ row, index })"
              *ngIf="
                row.estado !== e.ACTIVO &&
                shouldShowActiveButton &&
                (modelo
                  | puede
                    : a.CAMBIAR_ESTADO
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">toggle_off</mat-icon>
              <span>Activar</span>
            </button>
            <button
              type="button"
              mat-menu-item
              (click)="inactiveClick.emit({ row, index })"
              *ngIf="
                row.estado === e.ACTIVO &&
                shouldShowInactiveButton &&
                (modelo
                  | puede
                    : a.CAMBIAR_ESTADO
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">toggle_on</mat-icon>
              <span>Desactivar</span>
            </button>
          </mat-menu>
        </td>
        <ng-container *ngIf="shouldBeShowFooter">
          <td mat-footer-cell *matFooterCellDef>
            <strong>{{ column.footerDef && column.footerDef() }}</strong>
          </td>
        </ng-container>
      </ng-container>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    <ng-container *ngIf="shouldBeShowFooter">
      <tr mat-footer-row *matFooterRowDef="displayedColumns; sticky: true"></tr>
    </ng-container>
  </table>
</div>