
  <table mat-table [dataSource]="tableDataSource" matSort  >
    <ng-container
      *ngFor="let column of filteredColumns; let last = last"
      [matColumnDef]="column.def"
      [sticky]="column.sticky"
      [stickyEnd]="column.stickyEnd"

    >
      <ng-container *ngIf="column.def !== 'actions'">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          [disabled]="disableSort"
          [class.mat-header-cell-checkbox]="column.type === 'checkbox'"
          [ngClass]="{
            'sticky-column': isStickyColumn(column),
            'header-height': column.def !== 'actions' && column.def === 'estado_historial'
          }">
        <ng-container *ngIf="column.type === 'checkbox'">
          <mat-checkbox
            [checked]="allChecked"
            [indeterminate]="someChecked()"
            (change)="setAll($event.checked)"
            (click)="$event.stopPropagation()"
          >
            {{ column.title }}
          </mat-checkbox>
        </ng-container>
        <span *ngIf="column.type !== 'checkbox'"
        [ngClass]="{
          'align-right-title': column.def === 'a_cobrar_flete' ||
                              column.def === 'a_pagar_flete' ||
                              column.def === 'cantidad_flete' ||
                              column.def === 'cargado_flete' ||
                              column.def === 'saldo_flete' ||
                              column.def === 'credito_caja' ||
                              column.def === 'debito_caja' ||
                              column.def === 'saldo_caja' ||
                              column.def === 'credito_banco' ||
                              column.def === 'debito_banco' ||
                              column.def === 'saldo_banco',

          'align-right-cuenta':column.def === 'pendiente' ||
                                column.def === 'en_proceso' ||
                                column.def === 'confirmado' ||
                                column.def === 'cantidad_nominada' ||
                                column.def === 'cantidad_origen' ||
                                column.def === 'cantidad_destino' ||
                                column.def === 'diferencia_origen_destino' ||
                                column.def === 'condicion_propietario_tarifa' ||
                                column.def === 'propietario_flete_total' ||
                                column.def === 'propietario_flete_total_ml' ||
                                column.def === 'merma_propietario_valor' ||
                                column.def === 'merma_propietario_tolerancia' ||
                                column.def === 'merma_propietario_merma' ||
                                column.def === 'merma_propietario_valor_merma' ||
                                column.def === 'condicion_gestor_carga_tarifa' ||
                                column.def === 'gestor_carga_flete_total' ||
                                column.def === 'gestor_carga_flete_total_ml' ||
                                column.def === 'merma_gestor_carga_valor' ||
                                column.def === 'merma_gestor_carga_tolerancia' ||
                                column.def === 'merma_gestor_carga_merma' ||
                                column.def === 'merma_gestor_carga_valor_merma' ||
                                column.def === 'flete_condicion_propietario_tarifa' ||
                                column.def === 'flete_condicion_propietario_moneda_nombre' ||
                                column.def === 'flete_propietario_total' ||
                                column.def === 'flete_propietario_total_ml' ||
                                column.def === 'flete_merma_propietario_valor' ||
                                column.def === 'flete_merma_propietario_moneda_nombre' ||
                                column.def === 'flete_merma_propietario_tolerancia' ||
                                column.def === 'flete_merma_propietario_merma' ||
                                column.def === 'flete_merma_propietario_valor_merma' ||
                                column.def === 'flete_condicion_gestor_carga_tarifa' ||
                                column.def === 'flete_gestor_carga_total' ||
                                column.def === 'flete_merma_gestor_carga_valor' ||
                                column.def === 'flete_merma_gestor_carga_tolerancia' ||
                                column.def === 'flete_merma_gestor_carga_valor_merma' ||
                                column.def === 'total_complemento_a_cobrar' ||
                                column.def === 'total_descuento_a_pagar' ||
                                column.def === 'total_descuento_a_cobrar' ||
                                column.def === 'diferencia_descuento' ||
                                column.def === 'total_anticipo_retirado' ||
                                column.def === 'saldo_gestor_carga' ||
                                column.def === 'saldo_propietario',
            'align-right-monto':column.def === 'monto' ||
                                column.def === 'monto_ml' ||
                                column.def === 'movimientos_saldo' ||
                                column.def === 'instrumentos_saldo' ||
                                column.def === 'saldo_cc' ||
                                column.def === 'saldo_residual' ||
                                column.def === 'pago_cobro',

            'align-right-instr':column.def === 'credito_caja_instrumento' ||
                                column.def === 'debito_caja_instrumento' ||
                                column.def === 'saldo_caja' ||
                                column.def === 'credito_inst_banco' ||
                                column.def === 'debito_inst_banco'  ||
                                column.def === 'pendiente_inst_banco' ||
                                column.def === 'saldo_inst_banco',

            'align-right-oc':
                                column.def === 'total_anticipo' ||
                                column.def === 'total_complemento' ||
                                column.def === 'total_disponible' ||
                                column.def === 'total_retirado' ||
                                column.def === 'saldo' ||
                                column.def === 'created_by_anticipo' ||
                                column.def === 'created_at_anticipo' ||
                                column.def === 'modified_by_anticipo' ||
                                column.def === 'modified_at_anticipo',

              'align-right-porcentaje':
                                column.def === 'porcentaje',
              'align-right-oc-retirado':
                                column.def === 'monto_equiv'||
                                column.def === 'monto_retirado'
        }"
      >
          {{ column.title }}
        </span>
      </th>

        <td
          mat-cell
          *matCellDef="let row; let index = index"
          [ngClass]="{'sticky-column': isStickyColumn(column)}"
          [class.mat-cell-checkbox]="column.type === 'checkbox'"
          [class.row-error]="formArray.at(index)?.get(column.def)?.errors"
          [style.color]="getColorForStateNew(column, row)"
          [style]="getStilos(column, row)"
        >
          <ng-container
            *ngIf="
              column.value &&
              (!column.isHidden || (column.isHidden(row) && column.isHidden(row)))
            "
          >
            <ng-container [ngSwitch]="column.type">
              <ng-container *ngSwitchCase="'checkbox'">
                <mat-checkbox
                  [(ngModel)]="checkedList[index]"
                  (ngModelChange)="updateAllChecked()"
                  (change)="onCheckboxChange($event, row, index)"
                >
                  {{ column.value(row) }}
                </mat-checkbox>
              </ng-container>
              <ng-container *ngSwitchCase="'number'">
                <ng-container *ngIf="column.link">
                  <ng-container
                    *ngIf="column.link(row) as linkInfo; else withoutLink"
                  >
                    <a
                      [routerLink]="linkInfo.url"
                      [queryParams]="linkInfo.queryParams"
                    >
                      {{ column.value(row) | numberFormat }}
                    </a>
                  </ng-container>
                  <ng-template #withoutLink>
                    <span>{{ column.value(row) }}</span>
                  </ng-template>
                </ng-container>
                <ng-container *ngIf="!column.link">
                  <span>{{ column.value(row) | numberFormat }}</span>
                </ng-container>
              </ng-container>
              <ng-container *ngSwitchCase="'date'">
                <span>{{
                  column.value(row) | momentFormat: "DD-MM-YYYY HH:mm:ss"
                }}</span>
              </ng-container>
              <ng-container *ngSwitchCase="'only-date'">
                <span>{{
                  column.value(row) | momentFormat: "DD-MM-YYYY"
                }}</span>
              </ng-container>
              <ng-container *ngSwitchCase="'date-time'">
                <span>{{
                  column.value(row) | momentFormat: "DD-MM-YYYY HH:mm"
                }}</span>
              </ng-container>
              <ng-container *ngSwitchCase="'html'">
                <div [innerHTML]="column.value(row)"></div>
              </ng-container>
              <ng-container *ngSwitchCase="'button'">
                <ng-container *ngIf="column.buttonCallback">
                  <ng-container *ngIf="column.buttonIconName; else buttonText">
                    <ng-container *ngIf="column.buttonIconName(row) as iconName">
                      <button
                        type="button"
                        mat-icon-button
                        class="row-button"
                        [matTooltip]="column.value(row)"
                        [disabled]="column.isDisable && column.isDisable(row)"
                        (click)="column.buttonCallback(row)"
                        [ngClass]="{ 'pdf-button': column.def === 'pdf' }"
                      >
                        <mat-icon>{{ iconName }}</mat-icon>
                      </button>
                    </ng-container>
                  </ng-container>
                  <ng-template #buttonText>
                    <button
                      type="button"
                      mat-raised-button
                      class="row-button"
                      [innerHTML]="column.value(row)"
                      [disabled]="column.isDisable && column.isDisable(row)"
                      (click)="column.buttonCallback(row)"
                      [ngClass]="{ 'pdf-button': column.def === 'pdf' }"
                    ></button>
                  </ng-template>
                </ng-container>
              </ng-container>

              <ng-container *ngSwitchDefault>
                <ng-container *ngIf="column.link">
                  <ng-container
                    *ngIf="column.link(row) as linkInfo; else withoutLink"
                  >
                    <a
                      [routerLink]="linkInfo.url"
                      [queryParams]="linkInfo.queryParams"
                    >
                      {{ column.value(row) }}
                    </a>
                  </ng-container>
                  <ng-template #withoutLink>
                    <span>{{ column.value(row) }}</span>
                  </ng-template>
                </ng-container>
                <ng-container *ngIf="!column.link">
                  <span>{{ column.value(row) }}</span>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
        </td>
        <ng-container *ngIf="shouldBeShowFooter">
          <td mat-footer-cell *matFooterCellDef [ngClass]="{ 'text-right': column.footerDef && column.footerDef() === 'Total' }">
            <strong [ngSwitch]="column.type">
              <ng-container *ngSwitchCase="'number'">
                {{ column.footerDef && column.footerDef() | numberFormat }}
              </ng-container>
              <ng-container *ngSwitchDefault>
                {{ column.footerDef && column.footerDef() }}
              </ng-container>
            </strong>
          </td>

        </ng-container>
      </ng-container>
      <ng-container *ngIf="column.def === 'actions'" >
        <th mat-header-cell *matHeaderCellDef [hidden]="isShow && !addShowButton"  >
          <button
            type="button"
            mat-icon-button
            [matMenuTriggerFor]="filterColumn"
            #filterColumnTrigger
          >
            <mat-icon>list</mat-icon>
          </button>
          <mat-menu #filterColumn>
            <div mat-menu-item disableRipple>
              <app-searchable-checkbox-filter
                [value]="columnsToShowFilteredList"
                [list]="columnsToShowList"
                (valueChanges)="columnsToShowFilteredList = $event"
                (filtered)="
                  filterColumns();
                  filterColumnTrigger._elementRef.nativeElement.click()
                "
              ></app-searchable-checkbox-filter>
            </div>
          </mat-menu>
        </th>
        <td
          mat-cell
          *matCellDef="let row; let index = index"
          [hidden]="isShow && !addShowButton"
        >
          <button
            type="button"
            class="row_menu"
            mat-icon-button
            matTooltip="Ver"
            (click)="showClick.emit({ row, index })"
            *ngIf="modelo | puede: a.VER"
            [hidden]="!addShowButton"
          >
            <mat-icon>visibility</mat-icon>
          </button>
          <button
            type="button"
            class="row_menu"
            mat-icon-button
            [matMenuTriggerFor]="menu"
            [hidden]="isShow"
            *ngIf="
              ((modelo | puede: a.VER) && !hideShow) ||
              (!hideEdit &&
                (modelo | puede : a.EDITAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id || gestorCuentaId))) ||
              (!hideDelete &&
                (modelo
                  | puede
                    : a.ELIMINAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id || gestorCuentaId)))
            "
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <!-- TODO: la lista de opciones adicionales deberia pasarse por parametros entre componentes-->
            <button
              type="button"
              mat-menu-item
              (click)="showClickDos.emit({ row, index })"
              *ngIf="showBtnMovimientos &&
                (modelo | puede: a.VER)
                "
              [hidden]="hideShow"
            >
              <mat-icon color="primary">visibility</mat-icon>
              <span>Movimientos</span>
            </button>

            <button
              type="button"
              mat-menu-item
              (click)="showClick.emit({ row, index })"
              *ngIf="modelo | puede: a.VER"
              [hidden]="hideShow"
            >
              <mat-icon color="primary">visibility</mat-icon>
              <span>Ver</span>
            </button>

            <button
              type="button"
              mat-menu-item
              (click)="editClick.emit({ row, index })"
              *ngIf="
                row.estado !== e.CONCILIADO && row.estado !== e.CANCELADO && row.estado !== e.INACTIVO  &&
                hideButtonEdit(row) &&
                !hideEdit &&
                (modelo
                  | puede
                    : a.EDITAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">edit</mat-icon>
              <span>Editar</span>
            </button>

            <!--TODO: pasar una funcion para mostrar o no el boton, que reciba el registro actual y retorne true/false -->
            <button
              type="button"
              mat-menu-item
              (click)="deleteClick.emit({ row, index })"
              *ngIf="
                hideButtonDelete(row) &&
                !hideDelete &&
                (modelo
                  | puede
                    : a.ELIMINAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">delete</mat-icon>
              <span>Eliminar</span>
            </button>

            <button
              type="button"
              mat-menu-item
              (click)="anularAnticipoClick.emit({ row, index })"
              *ngIf="  hideButtonAnular(row) &&
              row.estado !== e.ANULADO &&
              shouldShowAnularButton &&
              (modelo
                | puede
                  : a.ANULAR
                  : (noCheckGestorCuentaId
                      ? undefined
                      : row.gestor_cuenta_id ||
                        row.gestor_carga_id ||
                        gestorCuentaId))
            "
          >
            <mat-icon color="primary">remove_circle</mat-icon>
            <span>Anular</span>
          </button>

           <button
              type="button"
                mat-menu-item
                (click)="ampliarClick.emit({ row, index })"
                *ngIf="showBtnAmpliar && row.estado !== e.CANCELADO &&
                  row.estado !== e.INACTIVO &&
                  (modelo | puede: a.VER)
                  "
                [hidden]="hideShow"
              >
              <mat-icon color="primary">add_circle</mat-icon>
              <span>Modificar</span>
            </button>

            <button
              type="button"
              mat-menu-item
              (click)="activeClick.emit({ row, index })"
              *ngIf="
                row.estado !== e.ACTIVO &&
                shouldShowActiveButton &&
                (modelo
                  | puede
                    : a.CAMBIAR_ESTADO
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">toggle_off</mat-icon>
              <span>Activar</span>
            </button>

            <button
              type="button"
              mat-menu-item
              (click)="inactiveClick.emit({ row, index })"
              *ngIf="
                row.estado === e.ACTIVO &&
                shouldShowInactiveButton &&
                (modelo
                  | puede
                    : a.CAMBIAR_ESTADO
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">toggle_on</mat-icon>
              <span>Desactivar</span>
            </button>

            <button
              type="button"
              mat-menu-item
              (click)="cancelarClick.emit({ row, index })"
              *ngIf="
                row.estado === e.ACTIVO &&
                shouldShowCancelarButton &&
                (modelo
                  | puede
                    : a.CAMBIAR_ESTADO
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">toggle_on</mat-icon>
              <span>Cancelar</span>
            </button>

            <button
              type="button"
              mat-menu-item
              (click)="forzarCierreClick.emit({ row, index })"
              *ngIf="hideButtonCierre(row) &&
                shouldShowForzarCierrerButton &&
                (modelo
                  | puede
                    : a.EDITAR
                    : (noCheckGestorCuentaId
                        ? undefined
                        : row.gestor_cuenta_id ||
                          row.gestor_carga_id ||
                          gestorCuentaId))
              "
            >
              <mat-icon color="primary">toggle_on</mat-icon>
              <span>Forzar Cierre</span>
            </button>
          </mat-menu>
        </td>
        <ng-container *ngIf="shouldBeShowFooter">
          <td mat-footer-cell *matFooterCellDef [ngClass]="{ 'text-right': column.footerDef && column.footerDef() === 'Total' }">
            <strong>{{ column.footerDef && column.footerDef() }}</strong>
          </td>

        </ng-container>
      </ng-container>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>

    <!--  TODO: prever hacer esto dinamico reutilizable para otros componentes   -->
    <!--  ahora solo funciona con preview de liquidacion   -->
    <ng-container matColumnDef="groupHeader" *ngIf="grouped">
      <td [attr.colspan]="displayedColumns.length-4" mat-cell *matCellDef="let group">
        <strong>{{group.groupName}}</strong>
      </td>
    </ng-container>

    <ng-container matColumnDef="groupTotales" *ngIf="grouped">
      <td colspan="3" mat-cell *matCellDef="let group">
        <strong>Totales:</strong> {{group.totales | numberFormat }}
      </td>
    </ng-container>

    <ng-container matColumnDef="groupTotalesML" *ngIf="grouped">
      <td colspan="1" mat-cell *matCellDef="let group">
        {{group.totalesML | numberFormat }}
      </td>
    </ng-container>

    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

    <ng-container *ngIf="grouped">
      <tr mat-row style="background-color: #f7f7f7 !important"
        *matRowDef="let row; columns: ['groupHeader', 'groupTotales', 'groupTotalesML'];  when: isGroup">
      </tr>
    </ng-container>

    <ng-container *ngIf="shouldBeShowFooter">
      <tr mat-footer-row *matFooterRowDef="displayedColumns; sticky: true"></tr>
    </ng-container>

  </table>
